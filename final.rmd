---
title: "STAT 240 Final Project"
output: html_document
---

## **Team Members**
Matthew Chiang, Siyu Huang, Vishnu Yaragadda

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(lubridate)
source("./scripts/viridis.R")
source("./scripts/ggprob.R")
```

```{r cache=TRUE, cache.path="cache/", include=FALSE}
# get all dates
file_list <- list.files(path="./data")

# load all data
allData <- data.frame()
for(i in 1:length(file_list)){
  
  # get file names
  league <- paste("./data/", file_list[i], "/LeagueTable.csv", sep="")
  standard <- paste("./data/", file_list[i], "/SquadStandardStats.csv", sep="")
  goalkeep <- paste("./data/", file_list[i], "/SquadGoalkeeping.csv", sep="")
  
  # load in each data table and merge it together
  LeagueTable <- read.csv(league)
  if( file.exists(standard) ){
    SquadStandardStats <- read.csv(standard)
    LeagueTable <- full_join(LeagueTable, SquadStandardStats, by="Squad")
  }
  if( file.exists(goalkeep) ){
    SquadGoalkeeping <- read.csv(goalkeep)
    LeagueTable <- full_join(LeagueTable, SquadGoalkeeping, by="Squad")
  }
  
  
  # add year column to the data
  LeagueTable <- select(LeagueTable, -contains(".y")) %>%
    mutate(year = substr(file_list[i], 6, 9))
  
  
  LeagueTable <- LeagueTable %>% 
    top_n(LeagueTable, 20)
  # combine the data into one big table
  if( i != 1){
    LeagueTable[setdiff(names(allData), names(LeagueTable))] <- NA
    allData[setdiff(names(LeagueTable), names(allData))] <- NA
  }
  allData <- rbind(allData, LeagueTable)
}
allData <- allData %>%
  select(Rk, Squad, W.x, D.x, L.x, GF, GA.x, Top.Team.Scorer, Poss, Saves,year)
```

## **Introduction**

"People cry when their team lose, and they cry even more when their team wins." Our team decided to conduct our analysis on the La Liga Football League as it is one of the most influential soccer leagues in the world. The league also has the most exciting rivalry in history: Real Madrid vs Barcelona, el clásico. Our team members are also fans of this soccer league and we decided to conduct research on the La Liga data. Throughout history, only nine different teams have been crowned champions, and we are curious about their common characteristics so that we can make predictions of these aspects for next season's champion. 

Starting off, we will take a look at the trend of total goals and saves of the champion of the league over the years. Then we will look into the top scorer's goals among the total goals because there is always a striker in the team that takes the responsibility of goals. Lastly we will see if the possession rates for champions are higher than other teams.


## **Background**

> Raw Data:

We found data for the La Liga Soccer League. Each season from 1988-2020, there are multiple sets of data ranging from team rankings, top scorers, standard squad statistics, team goalkeeping, team shooting, to statistics on individual players. We selected three sets of data:

* League Table: includes team rankings, total wins, loses, goals for, goals against, etc.
* Squad Standard Stats: includes general performance statistics of each team.
* Squad Goalkeeping: includes performance statistics for the goalkeeping of each team.

> Final Data: 

We had to collect the above data for the seasons between 1988-2020. We combined all of the data into one large dataframe called allData by the team name and created a year column to keep track of which teams data corresponds to which year. Then, we trimmed most of the variables in that large data set away and only selected the ones that were used in the analysis. 

**allData** contains the variables described below:

Variable| Description
----------------|------------
year|Season year 
Rk|Rank of each team for that season
Squad|Team Name
W.x|Number of wins for that team during season
L.x|Number of losses for that team during season
D.x|Number of draws for that team during season
GF|Total number of goals the team scored during season
GA.x|Total number of goals the team conceded during season
Top.Team.Scorer|Name of team's top scorer during season
Poss|Average Rate of Possession of the ball during season
Saves|Total number of saves the team had during season

> Data Citation:

"La Liga Seasons", Real Federación Española de Fútbol, 7th April 2020, https://fbref.com/en/comps/12/history/La-Liga-Seasons 
 
> Focus:
 
The overall aim of our analysis on this data will be to determine the characteristics of the winning team in the 2020-2021 La Liga Soccer League.


## **Analysis**

> Question 1: 
First, we wanted to look at the number of saves and goals of the champion of the LaLiga over the years. We want to see if we can make a linear regression model to predict the overall saves and goals of the winner. 

First, we look at the number of Saves of the champion over the years. 

```{r, echo = FALSE}
a <- allData %>%
  filter(allData$Saves != "N/A") %>%
  filter(Rk <= 3) %>%
  mutate(year = as.numeric(year)) %>%
  select(Saves, year)
a %>%
  ggplot(aes(x = year, y = Saves)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ggtitle("Number of Saves of Champion")
```

Just from looking at the graph, we can recognize that it has a pretty strong linear trend. So, now we look at the residuals so we can make sure those residuals follow an approximate normal distribution and have no strong pattern.

```{r, echo = FALSE}
lm0 <- lm(Saves~year, a)
library(modelr)
a <- a %>%
  add_residuals(lm0) %>%
  add_predictions(lm0)
ggplot(a, aes(x=year, y =resid)) +
  geom_point() +
  xlab("Years") +
  ylab("Residuals") +
  geom_hline(aes(yintercept=0), color="red", linetype = "dashed")
```

Since, the residuals are what they are supposed to be, we can state our linear model.

$$
Saves = -2.1710*year + 4472.9553
$$
```{r, include = FALSE}
summary(lm0)
confint(lm0)
```

However, these are only point estimates, so we will use a 95% confidence level to show our final results.

> Analysis: To conclude, our 95% confidence interval for the number of Saves will be between 95 and 116 saves.
Next, we want to look at the trend of Goals of the champion over the years. So, we will perform the same calculations as seen above.

```{r, echo = FALSE}
b <- allData %>%
  filter(allData$Saves != "N/A") %>%
  filter(Rk == "1") %>%
  mutate(year = as.numeric(year)) %>%
  select(GF, year)
b %>%
  ggplot(aes(x = year, y = GF)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  ylab("Goals") +
  ggtitle("Number of Goals of Champion")
lm1 <- lm(GF~year, b)
library(modelr)
b <- b %>%
  add_residuals(lm1) %>%
  add_predictions(lm1)
ggplot(b, aes(x=year, y =resid)) +
  geom_point() +
  xlab("Years") +
  ylab("Residuals") +
  geom_hline(aes(yintercept=0), color="red", linetype = "dashed")
```

Since the model has a clear linear trend and the residuals are what they are supposed to be, we can now state out linear model.

$$
Goals = 1.656*year - 3239.866
$$
```{r, include = FALSE}
ci_b <- b %>%
  pull(GF)
t.test(ci_b)
```

Now, we also state our 95% confidence interval for the number of Goals.

> Analysis: To conclude, our 95% confidence interval for the number of Goals will be between 80 and 97 Goals.


> Another potential characteristic of the winner of a season is the proportion of goals by top scorer among total goals of the team. 

For each champion team of each season, they have a top scorer that scores more goals than other players in the team and we believe that this consists of a sizable proportion of total goals of the team comparing to other teams. 
```{R echo=FALSE}
top_scorer <- allData %>% 
  mutate(top_scorer_goals = as.numeric(str_trim(str_sub(Top.Team.Scorer, -2, -1)))) %>% 
  # mutate(t2 = str_extract(Top.Team.Scorer, "[\d+][?!.*\d]$")) %>% 
  mutate(prop = top_scorer_goals / GF) %>% 
  mutate(year = as.numeric(year)) %>% 
  select(Squad, top_scorer_goals, GF, prop, year)
# ggplot(top_scorer, aes(x=year, y=prop)) +
#   geom_point() +
#   geom_smooth(method = "lm", se = FALSE, color = "hotpink") +
#   ggtitle("The proportion of goals by top scorer in each seasons") +
#   labs(x="Season", y="The proportion of goals by top scorer")
```

```{R echo=FALSE}
top_scorer2 <- allData %>%
  mutate(Rk = case_when(Rk == 1 ~ "Champion", 
                        TRUE ~ "Not Champion",)) %>%
  mutate(top_scorer_goals = as.numeric(str_trim(str_sub(Top.Team.Scorer, -2, -1)))) %>% 
  mutate(prop = top_scorer_goals / GF) %>% 
  mutate(year = as.numeric(year)) %>% 
  select(Rk, top_scorer_goals, GF, prop, year)

not_champion_top_scorer <- top_scorer2 %>% 
  filter(Rk == "Not Champion") %>% 
  group_by(year) %>% 
  summarise(not_champion_prop = mean(prop))
champion_top_scorer <- top_scorer2 %>% 
  filter(Rk == "Champion") %>% 
  group_by(year) %>% 
  summarise(champion_prop = mean(prop)) %>% 
  inner_join(not_champion_top_scorer)
```

```{R echo=FALSE}
champion_top_scorer2 = gather(champion_top_scorer, event, total, champion_prop:not_champion_prop) %>% 
  mutate(`Season Champion` = event)
# champion_top_scorer2
ggplot(champion_top_scorer2, aes(x=`Season Champion`, y=total, fill=`Season Champion`)) +
  geom_boxplot() +
  ggtitle("Comparison between champions and other teams", subtitle = ":the proportion of goals by top scorer in each seasons") +
  labs(x="Champions or not", y="The proportion of goals by top scorer", color = "Season Champion") 
```

From the observation of the graph, we assume that the proportion of top scorer's goals in champions teams tend to be higher than those of non-champions teams. To verify our guess, we can perform a hypothesis test.
$$
H_0: p_0 = p_1
$$
$$
H_a: p_0 > p_1
$$
where $\mu_0$ is the proportion of top scorer's goals over total goals for champions teams, and $\mu_1$ is the top scorer's goals over total goals for non-champions teams.
To carry out this test, we will consider a two-sample test with the following test statistic:
$$
T = \frac{p_0-p_1}{\sqrt{\frac{s_0^2}{n_0} + \frac{s_1^2}{n_1}}}
$$
```{R echo=FALSE}
# lm_s = lm()
t.test(champion_top_scorer$champion_prop, champion_top_scorer$not_champion_prop, alternative = "greater")

# top_scorer2 %>% 
#   group_by(Rk) %>% 
#   summarise(sum_top_scorer = sum(top_scorer_goals),
#             sum_GF = sum(GF))
# prop.test(c(858, 8118), c(2794, 29612))
```
We perform the hypothesis test where the null hypothesis is that the proportions are equal.  After doing the t-test, we found that the p-value is 0.01166 and it is statistically significant so that we can reject the null hypothesis. Therefore, The proportion of top scorer's goals of all goals in champions teams tend to be higher than those of non-champions teams.

<!-- > How about the trend of this proportion we just talked about? -->

```{R echo=FALSE}
# ggplot(top_scorer2, aes(x=year, y=prop, color=as.factor(Rk))) +
#   geom_point(alpha = 0.7) +
#   geom_smooth(method="lm", se = FALSE) +
#   scale_color_manual(values = c("darkgoldenrod", "blue")) +
#   ggtitle("The proportion of goals by top scorer in each seasons") +
#   labs(x="Season", y="The proportion of goals by top scorer", color = "Season Champion")
```

> One more potential characteristic of a winning team is the possession rate of that respective team. 

It's reasonable to assume that a winning team would have a higher possession rate as that would give the team more chances to score. So, we wanted to test that:

```{r, echo = FALSE}
poss <- allData %>%
  filter(Poss != "NA") %>%
  mutate(Rk = case_when(Rk <= 3 ~ "Top Teams", 
                        TRUE ~ "Rest of League",)) %>%
  group_by(Rk) %>%
  ggplot(aes(x = Poss, y = GF, color=as.factor(Rk))) +
  geom_point() +
  labs(x="Possession Rate", y="Goals Scored", color = "La Liga Teams") +
  ggtitle("Possession Rate vs Goals")

poss
  
```
The graph above supports our initial claim as the Top Teams have a much higher possession rate and thus end up with more goals scored. Now, we want to conduct a hypothesis test to reaffirm our claim that teams with high possession rates tend to do better. 

We can frame this as a hypothesis test described as follows:
$$
H_0: \mu_0 = \mu_1
$$
where $\mu_0$ is the mean possession rate for the rest of the league, and $\mu_1$ is the mean possession rate for the top teams.

$$
H_a: \mu_0 < \mu_1
$$

To carry out this test, we will consider a two-sample test with the following test statistic:
$$
T = \frac{(\bar{x}_0-\bar{x}_1) - (\mu_0-\mu_1)}{\sqrt{\frac{s_0^2}{n_0} + \frac{s_1^2}{n_1}}}
$$
where under the null $\mu_0 - \mu_1 = 0$, $n_i$ is the sample size for group $i=0,1$, and $s_i$ is the standard deviation of group $i$.

Since we are estimating the standard error, we will be using a t-distribution rather than a normal distribution.

```{r, echo = FALSE}
poss0 <- allData %>%
  filter(Poss != "NA") %>%
  filter(Rk > 3) %>%
  pull(Poss)

poss1 <- allData %>%
  filter(Poss != "NA") %>%
  filter(Rk <= 3) %>%
  pull(Poss)

mean0 <- mean(poss0)
sd0 <- sd(poss0)
n0 <- length(poss0)

mean1 <- mean(poss1)
sd1 <- sd(poss1)
n1 <- length(poss1)

## Assuming the null is true
se <- sqrt(sd0^2/n0+sd1^2/n1)
test_stat_poss <- (mean0-mean1)/se
test_stat_poss
```
```{r}
## Get degrees of freedom of t-distribution from t.test()
t.test(poss0, poss1, alternative ="less")

dof <- 19.6

pt(test_stat_poss, dof) # p-value = P(T_dof <= -9.76586)

```

Using a t-distribution with 19.6 degrees of freedom, we calculate a p-value on the order of $10^{-5}$ suggesting that we can reject the null hypothesis. This rejections means we have concluded that the mean possession rate for the top teams is greater than the mean possession rate for the rest of the league.

## Conclusion

One short coming of our project was that we had very limited amount of data. We only had about 20 years of data to work with which is not that much so our results might not be very accurate. Another short coming is that we tended to focus on only two aspects of the team in our linear regression. But, in reality, there might be a lot more variables that come into play. Instead of a linear regression, a multiple linear regression might suit this situation more, but we haven't learned that model yet.

When considering what makes a good soccer team, there are obviously more factors than just the number of goals and save they have. For example we could consider how a teams top player affects their performance within the league and factor that into our final analysis of the data. If we were to do this, we would find more data on specific player statistics, (i.e. Chances created, Shots On Goal, Possession Rate, etc.). We could also consider each teams overall offensive and defensive ratings and see how that has affected the winners of each season throughout history.