---
title: "STAT 240 Final Project"
output: html_document
---

## **Team Members**
Matthew Chiang, Siyu Huang, Vishnu Yaragadda

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(lubridate)
source("./scripts/viridis.R")
source("./scripts/ggprob.R")
```

```{r cache=TRUE, cache.path="cache/", include=FALSE}
# get all dates
file_list <- list.files(path="./data")

# load all data
allData <- data.frame()
for(i in 1:length(file_list)){
  
  # get file names
  league <- paste("./data/", file_list[i], "/LeagueTable.csv", sep="")
  standard <- paste("./data/", file_list[i], "/SquadStandardStats.csv", sep="")
  goalkeep <- paste("./data/", file_list[i], "/SquadGoalkeeping.csv", sep="")
  
  # load in each data table and merge it together
  LeagueTable <- read.csv(league)
  if( file.exists(standard) ){
    SquadStandardStats <- read.csv(standard)
    LeagueTable <- full_join(LeagueTable, SquadStandardStats, by="Squad")
  }
  if( file.exists(goalkeep) ){
    SquadGoalkeeping <- read.csv(goalkeep)
    LeagueTable <- full_join(LeagueTable, SquadGoalkeeping, by="Squad")
  }
  
  
  # add year column to the data
  LeagueTable <- select(LeagueTable, -contains(".y")) %>%
    mutate(year = substr(file_list[i], 6, 9))
  
  LeagueTable <- LeagueTable %>% 
    top_n(LeagueTable, 20)
  # combine the data into one big table
  if( i != 1){
    LeagueTable[setdiff(names(allData), names(LeagueTable))] <- NA
    allData[setdiff(names(LeagueTable), names(allData))] <- NA
  }
  
  allData <- rbind(allData, LeagueTable)
}
allData
```

## **Introduction**

Our team decided to conduct our analysis on the La Liga Football League as we all enjoy watching soccer and thought it would be interesting to try and make some sort of prediction on the winner of the current season. We decided that it would be best to analyze past seasons to predict the characteristics of the winner of the current season. 

To begin out approach we will look historicaly into the league to discover the probability that they win the current season. Then we will leverage a 95% confidence interval on a normal distribution of points and wins for the winners of the league. Lastly we will perform a linear regression on the winners of goals and saves vs years to exterpolate an estimation of how many saves and goals the 2020-2021 La Liga champion will have.

## **Background**

> Raw Data:

We found data for the La Liga Soccer League. Each season from 1988-2020, there are multiple sets of data ranging from team rankings, top scorers, standard squad statistics, team goalkeeping, team shooting, to statistics on individual players. We selected three sets of data:

* League Table: includes team rankings, total wins, loses, goals for, goals against, etc.
* Squad Standard Stats: includes general performance statistics of each team.
* Squad Goalkeeping: includes performance statistics for the goalkeeping of each team.

> Final Data: 

We had to collect the above data for the seasons between 1988-2020. We combined all of the data into one large dataframe by the team name and created a year column to keep track of which teams data cooresponds to which year.

> Data Citation:

"La Liga Seasons", Real Federación Española de Fútbol, 7th April 2020, https://fbref.com/en/comps/12/history/La-Liga-Seasons 
 
> Focus:
 
The overall aim of our analysis on this data will be to determine the characteristics of the winning team in the 2020-2021 La Liga Soccer League.


## **Analysis**

```{r echo=FALSE}
championNames <- allData %>% 
  filter(Rk == 1) %>%
  group_by(Squad, Rk) %>%
  summarize(
    wins = n()
  ) %>%
  ungroup() %>%
  mutate(pr = wins/sum(wins)) %>%
  arrange(desc(Rk), desc(wins))

championNames$Squad <- reorder(championNames$Squad, -championNames$pr)

ggplot(championNames, aes(x=Squad, y=pr, fill=factor(Rk))) +
  geom_col() +
  scale_fill_manual(values = c("#e05a5e", "#58e0d5")) +
  xlab("Team") +
  ylab("Probability of Winning League") +
  ggtitle("Percentage of Championship Wins", subtitle = "by Team") +
  theme(legend.position = "none")
```

> Question 1:

Firstly, we want to analyze the most direct factor that decides La Liga's winner of each season, that is the points each team get after 38 matches. In this league system, teams receive three points for a win, one point for a draw, and no points for a loss. Teams are ranked by total points, with the highest-ranked club at the end of the season crowned champion. From `r min(allData$year)` to `r max(allData$year)`, each winner's final point are gathered and we do the confidence interval on distribution to estimate the number of points that a champion should get. 

```{R echo=FALSE}
champions <- allData %>% 
  filter(Rk == 1)

mean_pt = mean(champions$Pts)
z_pt = 1.960 #this is the 95% confidence level value
s_pt = sd(champions$Pts)
n_pt = nrow(champions)
CI_pt = mean_pt + c(-1,1) * z_pt * s_pt / sqrt(n_pt)
gnorm(mean_pt, s_pt, color = 'cyan') +
  geom_vline(xintercept = CI_pt[1], color = 'hotpink', linetype = 2) +
  geom_vline(xintercept = CI_pt[2], color = 'hotpink', linetype = 2) +
  geom_text(aes(CI_pt[1],-0.001,label=round(CI_pt[1]))) +
  geom_text(aes(CI_pt[2],-0.001,label=round(CI_pt[2]))) +
  ggtitle('Normal distributions of champions points') +
  xlab('points')
```

From the distribution graph, we estimate that the winning point of 95% confidence interval should be between approximately `r CI_pt[1]` to `r CI_pt[2]`.

```{R echo=FALSE}
mean_wins = mean(champions$W.x)
z_wins = 1.960 #this is the 95% confidence level value
s_wins = sd(champions$W.x)
n_wins = nrow(champions)
CI_wins = mean_wins + c(-1,1) * z_wins * s_wins / sqrt(n_wins)
gnorm(mean_wins, s_wins, color = 'cyan') +
  geom_vline(xintercept = CI_wins[1], color = 'hotpink', linetype = 2) +
  geom_vline(xintercept = CI_wins[2], color = 'hotpink', linetype = 2) +
  geom_text(aes(CI_wins[1],-0.002,label=round(CI_wins[1]))) +
  geom_text(aes(CI_wins[2],-0.002,label=round(CI_wins[2]))) +
  ggtitle('Normal distributions of champions wins') +
  xlab('Number of Wins')
```

From the distribution graph, we estimate that the number of wins of 95% confidence interval should be between approximately `r CI_wins[1]` to `r CI_wins[2]`.

> Analysis: To conclude, we will have 95% confidence to say that the champion of the current season of La Liga will win `r CI_wins[1]` to `r CI_wins[2]` matches and get `r CI_pt[1]` to `r CI_pt[2]` points.

> Question 2: Next, we wanted to look at the number of saves and goals of the champion of the LaLiga over the years. We want to see if we can make a linear regression model to predict the overall saves and goals of the winner. 

First, we look at the number of Saves of the champion over the years. 

```{r, echo = FALSE}
a <- allData %>%
  filter(allData$Saves != "N/A") %>%
  filter(Rk == "1") %>%
  mutate(year = as.numeric(year)) %>%
  select(Saves, year)

a %>%
  ggplot(aes(x = year, y = Saves)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

```

Just from looking at the graph, we can recognize that it has a pretty strong linear trend. So, now we look at the residuals so we can make sure those residuals follow an approximate normal distribution and no strong pattern.

```{r, echo = FALSE}

lm0 <- lm(Saves~year, a)

library(modelr)
a <- a %>%
  add_residuals(lm0) %>%
  add_predictions(lm0)

ggplot(a, aes(x=year, y =resid)) +
  geom_point() +
  xlab("x") +
  ylab("Residuals") +
  geom_hline(aes(yintercept=0), color="red", linetype = "dashed")
```

Since, the residuals are what they are supposed to be, we can state our linear model.

$$
Saves = -2.516*year + 5159.044
$$
```{r, include = FALSE}
ci_a <- a %>%
  pull(Saves)

t.test(ci_a)
```

However, these are only point estimates, so we will use a 95% confidence level to show our final results.

> Analysis: To conclude, our 95% confidence interval for the number of Saves will be between 95 and 116 saves.

Next, we want to look at the trend of Goals of the champion over the years. So, we will perform the same calculations as seen above.

```{r, echo = FALSE}
b <- allData %>%
  filter(allData$Saves != "N/A") %>%
  filter(Rk == "1") %>%
  mutate(year = as.numeric(year)) %>%
  select(Gls, year)

b %>%
  ggplot(aes(x = year, y = Gls)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

lm1 <- lm(Gls~year, b)

library(modelr)
b <- b %>%
  add_residuals(lm1) %>%
  add_predictions(lm1)

ggplot(b, aes(x=year, y =resid)) +
  geom_point() +
  xlab("x") +
  ylab("Residuals") +
  geom_hline(aes(yintercept=0), color="red", linetype = "dashed")
```

Since the model has a clear linear trend and the residuals are what they are supposed to be, we can now state out linear model.

$$
Goals = 2.788*year - 5513.918
$$
```{r, include = FALSE}
ci_b <- b %>%
  pull(Gls)

t.test(ci_b)
```

Now, we also state our 95% confidence interval for the number of Goals.

> Analysis: To conclude, our 95% confidence interval for the number of Goals will be between 77 and 96 Goals.







